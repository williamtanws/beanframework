<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout">
<body>
	<th:block layout:fragment="customer (customers)">
		<table id="customerTable" class="table table-bordered table-hover" style="width:100%">
			<thead>
				<tr>
					<th th:text="#{module.backoffice.id}" class="text-center"></th>
					<th th:text="#{module.backoffice.name}" class="text-center"></th>
					<th th:text="#{module.backoffice.select}" class="text-center"></th>
				</tr>
			</thead>
			<thead>
				<tr>
					<th></th>
					<th></th>
					<th></th>
				</tr>
			</thead>
		</table>
		<div id="selectedCustomers">
			<th:block th:each="customer : *{__${customers}__}">
				<input type="hidden" name="selectedCustomers" th:value="${customer.uuid}" />
			</th:block>
		</div>
		<script th:inline="javascript">
		    /*<![CDATA[*/
		    	
		    var locale = /*[[${#locale}]]*/;
		    
		    var ajaxUrl = /*[[@{${@environment.getProperty('path.api.customer.page')}}]]*/;

		    var customers = [];
		    /*[# th:each="object : *{__${customers}__}"]*/  	    
		    customers.push(/*[[${object.uuid}]]*/); 	    
		    /*[/]*/
		    
		    var customerTable = $('#customerTable').DataTable({
	    		  'language' : {
			        'url' : '/static/common/plugin/datatables/language/'+locale+'.json'
			      },
	    	      'pageLength'  : 10,
	    	      'paging'      : true,
	    	      'lengthChange': true,
	    	      'searching'   : true,
	    	      'ordering'    : true,
	    	      'info'        : true,
	    	      'autoWidth'   : true,
	    	      'processing': true,
	    	      'serverSide': true,
	    	      'searchDelay': 1000,
		    	  'bStateSave': true,
	    	      'dom': "<'row'<'col-sm-12 col-md-6'Bl><'col-sm-12 col-md-6'f>>" +
	    	      "<'row'<'col-sm-12'tr>>" +
	    	      "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>", 
	    	      'buttons': [
	                  {
	                      text: 'Clear', className: 'btn btn-primary btn-datatable', init: function(api, node, config) { $(node).removeClass('dt-button') },
	                      action: function ( e, dt, node, config ) {
	                    	  dt.search('').columns().search('').draw();dt.order.neutral().draw();
	                    	  $('#customerTable').find("input:text").val("");
	                    	  $("#customerTable").find("select").each(function () { // there is no such thing as input[type=select] 
	                    	        this.selectedIndex = 0; // this is a <select>
	                    	  });
	                    	  $('#customerTable .select2').val('').trigger('change');
	                      }
	                  }
	              ],
	    	      'ajax': {
	                    'url': ajaxUrl
	              },
	              'columns': [
	                    { "data": "id" },
	                    { "data": "name" },
	                    { "data": "" }
	              ],
	    	      'columnDefs': [
	    	            { 
	    	                targets: 2,
	    	                'searchable': false,
	    	                'orderable': false,
	    	                'className': 'text-center',
	    	                render: function(data, type, row, meta)
	    	                {
	    	                   var selected = customers.includes(row.uuid);
	    	                   if(selected){
	    	                	   return "<input type='checkbox' value='"+row.uuid+"' name='tableSelectedCustomers' checked>"; 
	    	                   }
	    	                   else{
	    	                	   var preventSelfUuid = /*[[*{uuid}]]*/;
	    	                	   if(preventSelfUuid == row.uuid){
		    	                	   return ""; 
	    	                	   }
	    	                	   else{
		    	                	   return "<input type='checkbox' value='"+row.uuid+"' name='tableSelectedCustomers'>"; 
	    	                	   }
	    	                   }
	    	                    
	    	                }
	    	            },
		            	{                                 
		                	"targets": '_all',
		                	"render": $.fn.dataTable.render.text()
		                }              
	    	       ]
	    	});
		    
		    $('#customerTable').on('draw.dt', function () {
		    	$('input').iCheck({
					checkboxClass : 'icheckbox_square-blue',
					radioClass : 'iradio_square-blue',
					increaseArea : '20%' // optional
				});
		    });
		    
		    $('#customerTable').on('ifChecked', 'input[name="tableSelectedCustomers"]', function () {
		    	$('#selectedCustomers').append('<input type="hidden" name="selectedCustomers" value="'+this.value+'"/>');
		    	customers.push(this.value);
		    });
		    
		    $('#customerTable').on('ifUnchecked', 'input[name="tableSelectedCustomers"]', function () {
		    	$('#selectedCustomers input[type="hidden"][name="selectedCustomers"][value="'+this.value+'"]').remove();
		    	for( var i = 0; i < customers.length; i++){ 
		    		if ( customers[i] === this.value) {
		    			customers.splice(i, 1); 
		    		}
		    	}
		    });
		    
		    $(document).ready(function ()
		    {
		    	$('#customerTable thead tr:eq(1) th').each(function(index){
		    		if(index < 2){
		    			var title = $('#customerTable thead tr:eq(0) th').eq( $(this).index() ).text();
		    			var searchPlaceHolder = /*[[#{module.backoffice.search}]]*/;
		            	$(this).html('<input type="text" class="form-control" style="width: 100%;" placeholder="' + searchPlaceHolder + ' '+ title + '" />');
		    		} else{
			            $(this).html('');
		    		}
		        });
		    	
		    	customerTable.columns().every(function (index) {
		    	    $('#customerTable thead tr:eq(1) th:eq(' + index + ') input').on('keyup change', function () {
		    	    	customerTable.column($(this).parent().index() + ':visible')
		    	            .search(this.value)
		    	            .draw();
		    	    });
		    	});
		    });
		    /*]]>*/
		</script>
		<th:block sec:authorize="hasAuthority('customer_read')">
			<script th:inline="javascript">
		    	/*<![CDATA[*/
		    		$('#customerTable').on('click', 'tbody tr', function() {
						//console.log('API row values : ', mainTable.row(this).data());
						var uuid = customerTable.row(this).data().uuid;
						if(uuid){
							var url = /*[[@{${@environment.getProperty('path.customer')}}]]*/;
							url += '?uuid='+uuid+'#tab_general';
							window.open(url, '_blank');
						}
					});
		    	/*]]>*/
			</script>
		</th:block>
	</th:block>
</body>
</html>