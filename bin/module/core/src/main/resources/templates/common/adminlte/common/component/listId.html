<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout">
<body>
	<th:block layout:fragment="list (icon, title, objectDto, createAuthority, updateAuthority, tableName, listUrl, listFields, editFormAction, editForm, createButton, filterColumnIndex)">
		<!-- Alert Notification-->
		<div class="row">
			<th:block layout:insert="~{common/adminlte/common/component/alert :: custom}"></th:block>
		</div>
		<div class="row">
			<div class="col-md-12">
				<div class="box box-solid">
					<!-- /.box-header -->
					<div class="box-group" id="accordion">
						<!-- we are adding the .panel class so bootstrap.js collapse plugin detects it -->
						<div class="panel box box-primary">
							<div class="box-header with-border">
								<h4 class="box-title">
									<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" th:aria-expanded="${objectDto.id != null || create ? 'false':'true'}"
										th:class="${objectDto.id != null || create ? 'collapsed':''}">
										<span th:class="${icon}"></span>
										&nbsp;&nbsp;
										<span th:text="${title}+' ('"></span>
										<span id="total-records"></span>
										<span th:text="')'"></span>
										<i class="fa fa-fw fa-angle-double-down"></i>
									</a>
								</h4>
							</div>
							<div id="collapseOne" th:class="'panel-collapse collapse '+${objectDto.id != null || create ? '':'in'}">
								<div class="box-body">
									<div class="row">
										<div class="col-md-12">
											<div class="box-body bg-gray">
												<div class="row" style="min-height:34px">
													<div class="col-md-6">
														<th:block th:if="${createButton == '1'}">
															<a th:href="${editFormAction}+'?create'" type="button" class="btn btn-default" th:if="${#authorization.expression('hasAuthority('''+createAuthority+''')')}">
																<span class="fa fa-plus color"></span>
															</a>
														</th:block>
													</div>
												</div>
												<!-- /.box-header -->
											</div>
										</div>
										<div class="col-md-12" style="padding-top:10px">
											<div class="dataTables_wrapper form-inline dt-bootstrap">
												<table id="mainTable" class="table table-bordered table-hover dataTable" style="width: 100%">
													<thead>
														<tr>
															<th th:each="field : ${listFields}" th:text="${field[1]}" class="text-center"></th>
														</tr>
													</thead>
													<thead>
														<tr>
															<th th:each="field : ${listFields}"></th>
														</tr>
													</thead>
												</table>
											</div>
										</div>
									</div>
								</div>
							</div>
							<form id="edit-form" th:action="${editFormAction}+'#tab_general'" method="get" th:object="${objectDto}" style="display: none">
								<input type="hidden" name="id">
							</form>
							<th:block layout:insert="~{common/adminlte/common/component/list :: js}"></th:block>
						</div>
						<div class="panel box box-success" th:if="${objectDto.id != null || create}">
							<div class="box-header with-border">
								<h4 class="box-title">
									<a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" th:aria-expanded="${objectDto.id != null || create ? 'true':'false'}"
										th:class="${objectDto.id == null ? 'collapsed':''}">
										<span th:if="${objectDto.id != null}" th:text="${objectDto.id == null} ?  'UUID: '+${objectDto.id} : 'ID: '+${objectDto.id}"></span>
										<span th:if="${create}" th:text="#{module.common.create}"></span>
										<i class="fa fa-fw fa-angle-double-down"></i>
									</a>
								</h4>
							</div>
							<div id="collapseTwo" th:class="'panel-collapse collapse '+${objectDto.id != null || create ? 'in':''}">
								<div class="box-body">
									<th:block layout:insert="~{${editForm} :: update}" th:if="${objectDto.id != null || create}"></th:block>
								</div>
							</div>
						</div>
					</div>
					<!-- /.box-body -->
				</div>
			</div>
		</div>
	</th:block>

	<th:block layout:fragment="js">
		<script th:inline="javascript">
		    /*<![CDATA[*/
		    	
		    var locale = /*[[${#locale}]]*/;
		    
		    var columns = [];
		    /*[# th:each="object,itrStat : ${listFields}"]*/  	    
		    columns.push({"data":[[${object[0]}]]});
		    /*[/]*/
		    
		    var tableName = /*[[${tableName}]]*/;
		    		    
		    var mainTable = $('#mainTable').DataTable({
	    		  'language' : {
			        'url' : '/static/common/plugin/datatables/language/'+locale+'.json'
			      },
	    	      'pageLength'  : 10,
	    	      'fixedHeader' : true,
	    	      'paging'      : true,
	    	      'lengthChange': true,
	    	      'searching'   : true,
	    	      'ordering'    : true,
	    	      'info'        : true,
	    	      'autoWidth'   : true,
	    	      'processing': true,
	    	      'serverSide': true,
	    	      'searchDelay': 1000,
		    	  'bStateSave': true,
	    	      'dom': "<'row'<'col-sm-12 col-md-6'Bl><'col-sm-12 col-md-6'f>>" +
	    	      "<'row'<'col-sm-12'tr>>" +
	    	      "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",  
	    	      'buttons': [
	                  {
	                      text: 'Clear', className: 'btn btn-primary btn-datatable', init: function(api, node, config) { $(node).removeClass('dt-button') },
	                      action: function ( e, dt, node, config ) {
	                    	  dt.search('').columns().search('').draw();dt.order.neutral().draw();
	                    	  $('#mainTable').find("input:text").val("");
	                    	  $("#mainTable").find("select").each(function () { // there is no such thing as input[type=select] 
	                    	        this.selectedIndex = 0; // this is a <select>
	                    	  });
	                    	  $('#mainTable .select2').val('').trigger('change');
	                      }
	                  }
	              ],
	    	      'fnStateSave': function (oSettings, oData) {
	    	            sessionStorage.setItem(tableName, JSON.stringify(oData));
	    	      },
	    	      'fnStateLoad': function (oSettings) {
	    	            return JSON.parse(sessionStorage.getItem(tableName));
	    	      },
	    	      'ajax': {
	                    'url':/*[[${listUrl}]]*/
	              },
	              'columns': columns,
	              'columnDefs': [
	            	  { 
	    	                targets: 0,
	    	                'className': 'text-bold'
	            	  },
	            	  {                                 
	                      "targets": '_all',
	                      "render": $.fn.dataTable.render.text()
	                  }
	              ],
	    	      'fnDrawCallback': function() {
	    	           initialSearch();
	    	           initialTitle();
	    	      }
	    	});
		    
		    function initialSearch() {
		    	$('#searchAll').val(mainTable.search());
		    }
		    
		    function initialTitle() {
		    	$('#total-records').text(mainTable.page.info().recordsTotal);
		    }
		    
			function editForm(id) {
				$('#edit-form input[name="id"]').val(id);
				$('#edit-form').submit();
			}
			
			$('#length-change').change( function() { 
				mainTable.page.len( $(this).val() ).draw();
			});
			
			$('#mainTable').on('click', 'tbody tr', function() {
				//console.log('API row values : ', mainTable.row(this).data());
				var id = mainTable.row(this).data().id;
				editForm(id);
			});
			
			$(document).ready(function() {
				
				var filterColumnIndex = /*[[${filterColumnIndex}]]*/ ;
				
				if(filterColumnIndex){
				    $('#mainTable thead tr:eq(1) th').each(function(index) {
				        if(filterColumnIndex.includes(index)){
				        	var title = $('#mainTable thead tr:eq(0) th').eq($(this).index()).text();
					        var searchPlaceHolder = /*[[#{module.common.search}]]*/ ;
					        var search = '';
					        
					        if(mainTable.state.loaded()){
						        search = mainTable.state.loaded().columns[index].search.search;
					        }
					        
					        $(this).html('<input type="text" class="form-control" style="width: 100%;" placeholder="' + searchPlaceHolder + ' ' + title + '" value="' + search + '" />');
				        
					        $('input', this ).on('keyup change', function () {
					            if ( mainTable.column(index).search() !== this.value ) {
					            	mainTable
					                    .column(index)
					                    .search( this.value )
					                    .draw();
					            }
					        });
				        
				        }
				        else{
				        	$(this).html('');
				        }
				    });
	
				    $('#searchAll').keyup(function() {
				        mainTable.search($(this).val()).draw();
				    });
			    
				}
			});
		    /*]]>*/
		</script>
	</th:block>
</body>
</html>