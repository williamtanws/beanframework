<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
	<th:block th:fragment="datatable">
		<div class="card-body">
			<table id="historyDataTable" class="table table-bordered table-striped">
				<thead>
					<tr>
						<th th:text="#{module.history.revisionDate}" class="text-center" style="width: 108px;"></th>
						<th th:text="#{module.history.revisionType}" class="text-center" style="width: 100px;"></th>
						<th th:text="#{module.history.propertiesChanged}" class="text-center"></th>
						<th th:text="#{module.history.user}" class="text-center"></th>
					</tr>
				</thead>
			</table>
		</div>
	</th:block>
	<th:block th:fragment="js (historyUrl)">
		<script th:inline="javascript">
		/*<![CDATA[*/			
			var historyUrl = /*[[${historyUrl}]]*/;
			$(document).ready(function () {

				$('#historyDataTable').DataTable({
					"lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
			    	"responsive" : true,
					'pageLength'  : 10,
		    	    'paging'      : true,
		    	    'lengthChange': true,
		    	    'searching'   : false,
		    	    'ordering'    : true,
		    	    'info'        : true,
		    	    'autoWidth'   : false,
		    	    'processing': true,
		    	    'serverSide': true,
		    	    'searchDelay': 1000,
			        'bStateSave': false,
			        'dom': "<'row'<'form-group col-sm-12 col-md-12'B>>" +
		    	      "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
		    	      "<'row'<'col-sm-12'tr>>" +
		    	      "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>", 
					'ajax': historyUrl,
					"columns": [
						{ "data": "revisionDate" },
						{ "data": "revisionType" },
						{ "data": "entity" },
						{ "data": "entity" }
					],
					"columnDefs": [
						{
							"targets": 0,
							"render": function (data, type, row) {
								return row.revisionDate;
							}
						},
						{
							"targets": 1,
							"render": function (data, type, row) {
								return row.revisionType;
							}
						},
						{
							"targets": 2,
							"render": function (data, type, row) {
								var message = "";
								$.each(row.propertiesChanged, function (index, property) {

									var value = row.entity[property];
									if (value instanceof Array) {
										var newValue = "";
										for (i = 0; i < value.length; i++) {
											if (i > 0) {
												newValue += ', ';
											}
											if (value[i].id == null) {
												newValue += value[i].uuid;
											}
											else {
												newValue += value[i].id;
											}
										}
										value = newValue;
									}
									else if (Object.prototype.toString.call(value) === '[object Object]') {
										if (value.id == null) {
											value = value.uuid;
										}
										else {
											value = value.id;
										}
									}

									if (index != 0) {
										message = message + "<br>";
									}

									message = message + " [" + property + "] <span class='fa fa-arrow-right'></span> " + value;
								});
								if (message === '') {
									message = message + " [id] <span class='fa fa-arrow-right'></span> " + row.entity['id'] + "<br>";
									message = message + " [value] <span class='fa fa-arrow-right'></span> " + row.entity['value'];
								}
								return message;
							}
						},
						{
							"targets": 3,
							"render": function (data, type, row) {
								if (row.entity.lastModifiedBy) {
									return row.entity.lastModifiedBy.name + ' [' + row.entity.lastModifiedBy.id + ']';
								}
								else if (row.entity.createdBy) {
									return row.entity.createdBy.name + ' [' + row.entity.createdBy.id + ']';
								}
								else {
									return 'System';
								}
							}
						}
					],
					"buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
				});
			});
		/*]]>*/
		</script>
	</th:block>
</body>
</html>