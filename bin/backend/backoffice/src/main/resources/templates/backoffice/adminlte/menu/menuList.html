<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	layout:decorate="/backoffice/adminlte/common/layout/layoutBackoffice">
<head>
<title th:text="#{module.menu}"></title>
<!-- jstree -->
<link rel="stylesheet" th:href="@{/static/common/plugin/jstree/dist/themes/default/style.min.css}" />
</head>
<body>
	<th:block layout:fragment="content">
		<section class="content">
			<div class="row">
				<th:block layout:replace="/backoffice/adminlte/common/fragment/alert :: custom"></th:block>
			</div>
			<div class="row">
				<div class="col-md-12">
					<div class="box box-solid">
						<!-- /.box-header -->
						<div class="box-group" id="accordion">
							<!-- we are adding the .panel class so bootstrap.js collapse plugin detects it -->
							<div class="panel box box-primary">
								<div class="box-header with-border">
									<h4 class="box-title">
										<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" th:aria-expanded="${menuUpdate.uuid == null ? 'true':'false'}" th:class="${menuUpdate.uuid == null ? '':'collapsed'}">
											<span th:class="@{${@environment.getProperty('module.menu.icon')}}"></span>
											&nbsp;&nbsp;
											<span th:text="#{module.menu}"></span>
											<i class="fa fa-fw fa-angle-double-down"></i>
										</a>
									</h4>
								</div>
								<div id="collapseOne" th:class="'panel-collapse collapse '+${menuUpdate.uuid == null ? 'in':''}">
									<div class="box-body">
										<div class="row">
											<div class="col-md-12">
												<div class="box box-solid">
													<div class="box-body bg-gray">
														<div class="row">
															<div class="col-xs-4">
																<button type="button" class="btn btn-default" data-toggle="modal" data-target="#modal-create" sec:authorize="hasAuthority('menu_create')">
																	<span class="fa fa-plus color"></span>
																</button>
															</div>
														</div>
													</div>
													<!-- /.box-header -->
												</div>
											</div>
											<div class="col-md-12">
												<div id="menu-tree"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="panel box box-success" th:if="${menuUpdate.uuid != null}" sec:authorize="hasAuthority('menu_update')">
								<div class="box-header with-border">
									<h4 class="box-title">
										<a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" th:aria-expanded="${menuUpdate.uuid == null ? 'false':'true'}" th:class="${menuUpdate.uuid == null ? 'collapsed':''}">
											<span th:text="'ID: '+${menuUpdate.id}"></span>
											<i class="fa fa-fw fa-angle-double-down"></i>
										</a>
									</h4>
								</div>
								<div id="collapseTwo" th:class="'panel-collapse collapse '+${menuUpdate.uuid == null ? '':'in'}">
									<div class="box-body">
										<th:block layout:replace="/backoffice/adminlte/menu/menuForm :: update" th:if="${menuUpdate.uuid != null}"></th:block>
									</div>
								</div>
							</div>
						</div>
						<!-- /.box-body -->
					</div>
				</div>
			</div>
			<th:block layout:replace="/backoffice/adminlte/menu/menuForm :: create"></th:block>
		</section>
		<form id="change-form" style="display: none" th:action="@{${@environment.getProperty('path.menu')}}" method="post">
			<input type="hidden" name="move">
			<input name="fromUuid" id="fromUuid">
			<input name="toUuid" id="toUuid">
			<input name="toIndex" id="toIndex">
		</form>
		<input id="hasAuthorityMenuUpdate" sec:authorize="hasAuthority('menu_update')" type="hidden" value="true" />
		<input id="hasAuthorityMenuUpdate" sec:authorize="!hasAuthority('menu_update')" type="hidden" value="false" />
	</th:block>
	<th:block layout:fragment="js">
		<!-- jstree -->
		<script type="text/javascript" th:src="@{/static/common/plugin/jstree/dist/jstree.min.js}"></script>
		<script th:inline="javascript">
			/*<![CDATA[*/
				
			var url = /*[[${@environment.getProperty('path.menu')}]]*/;
			
			var menuSelectId = /*[[${menuSelectedUuid != null}? ${menuSelectedUuid.toString()}:'']]*/ ;
			var menuUpdateId = /*[[${menuUpdate.uuid != null}? ${menuUpdate.uuid.toString()}:'']]*/ ;
			
			var urlTree = /*[[${@environment.getProperty('path.api.menu.tree')}]]*/;
			
			if($('#hasAuthorityMenuUpdate').val() == 'true'){
				$(function() {
					$('#menu-tree').jstree(
							{
								"core" : {
									"check_callback" : function(operation, node,
											parent, position, more) {
										if (operation === "copy_node"
												|| operation === "move_node") {
											if (parent.uuid === "#") {
												return false; // prevent moving a child above or below the root
											}
										}
										return true; // allow everything else
									},
									"data" : {
										"url" : urlTree+"?uuid="+menuSelectId+menuUpdateId,
										"dataType" : "json" // needed only if you do not supply JSON headers
									}
								},
								"plugins" : [ "dnd" ]
							}).bind("move_node.jstree", function(e, data) {
	
						//console.log("Drop node " + data.node.id + " to " + data.parent);
						//console.log("Change position from " + data.old_position + " to " + data.position);
	
						$('#fromUuid').val(data.node.id);
						
						if(data.parent == '#'){
							$('#toUuid').remove();
						}
						else{
							$('#toUuid').val(data.parent);
						}
						$('#toIndex').val(data.position);
	
						$('#change-form').submit();
	
					}).bind("select_node.jstree", function(e, data) {
						window.location = url + "?uuid="+ data.node.id;
					});
				});
			}
			else{
				$(function() {
					$('#menu-tree').jstree(
							{
								"core" : {
									"data" : {
										"url" : urlTree+"?uuid="+menuSelectId+menuUpdateId,
										"dataType" : "json" // needed only if you do not supply JSON headers
									}
								}
							});
				});
			}

			function getPage(page) {
				$('#pagination-form input[name="page"]').val(page);
				$('#pagination-form').submit();
			}

			function getForm(uuid) {
				$('#get-menu-form input[name="uuid"]').val(uuid);
				$('#delete-menu-form input[name="uuid"]').val(uuid);
				$('#get-menu-form').submit();
			}
			/*]]>*/
		</script>
	</th:block>
</body>
</html>