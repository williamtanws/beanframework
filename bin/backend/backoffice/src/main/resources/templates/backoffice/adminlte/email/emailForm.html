<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	layout:decorate="~{${@environment.getProperty('layout.backoffice')}}">
<head>
<title th:utext="#{module.email}"></title>
</head>
<body>
	<th:block layout:fragment="update">
		<form id="update-form" role="form" th:action="${@environment.getProperty('path.email')}" method="post" th:object="${emailUpdate}">
			<input type="hidden" name="update" />
			<input type="hidden" name="status" th:value="${emailUpdate.status.name()}">
			<input type="hidden" name="uuid" th:value="${emailUpdate.uuid}" />
			<div class="row">
				<div class="col-md-12">
					<div class="box box-solid">
						<div class="box-body bg-gray">
							<div class="row">
								<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
									<th:block layout:insert="~{/backoffice/adminlte/common/component/delete :: button (deleteAuthority='email_delete')}"></th:block>
								</div>
								<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="text-align: center">
									<button type="button" class="btn btn-success" th:text="#{module.email.sendemailbyqueue}" sec:authorize="hasAuthority('email_update')" onclick="sendEmailByQueue()"></button>
								</div>
								<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="text-align: right">
									<th:block layout:insert="~{/backoffice/adminlte/common/component/refresh :: button (deleteAuthority='email_delete')}"></th:block>
									<th:block layout:insert="~{/backoffice/adminlte/common/component/update :: button (updateAuthority='email_update')}"></th:block>
								</div>
							</div>
						</div>
						<!-- /.box-header -->
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<!-- Custom Tabs -->
					<div class="nav-tabs-custom">
						<ul class="nav nav-tabs">
							<li class="active">
								<a href="#tab_general" data-toggle="tab" th:text="#{module.backoffice.general}" onclick="changeTab('general')"></a>
							</li>
							<li>
								<a href="#tab_status" data-toggle="tab" th:text="#{module.email.status}" onclick="changeTab('status')"></a>
							</li>
							<li>
								<a href="#tab_history" data-toggle="tab" th:text="#{module.backoffice.history}" onclick="changeTab('history')"></a>
							</li>
							<li>
								<a href="#tab_administration" data-toggle="tab" th:text="#{module.backoffice.administration}" onclick="changeTab('administration')"></a>
							</li>
						</ul>
						<div class="tab-content tab-validate">
							<div class="tab-pane active" id="tab_general">
								<div class="box-body">
									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label for="name" th:text="#{module.email.name}"></label>
												<span>*</span>
												<input class="form-control" name="name" th:value="*{name}"></input>
											</div>
										</div>
									</div>
									<div class="row" style="border-top: 1px solid #f4f4f4; padding-top: 10px;">
										<div class="col-md-6">
											<div class="form-group">
												<label for="toRecipients" th:text="#{module.email.torecipients}"></label>
												<textarea class="form-control" name="toRecipients" th:text="*{toRecipients}"></textarea>
												<span class="help-block"></span>
											</div>
											<div class="form-group">
												<label for="ccRecipients" th:text="#{module.email.ccrecipients}"></label>
												<textarea class="form-control" name="ccRecipients" th:text="*{ccRecipients}"></textarea>
												<span class="help-block"></span>
											</div>
										</div>
										<div class="col-md-6">
											<div class="form-group">
												<label for="bccRecipients" th:text="#{module.email.bccrecipients}"></label>
												<textarea class="form-control" name="bccRecipients" th:text="*{bccRecipients}"></textarea>
												<span class="help-block"></span>
											</div>
										</div>
									</div>
									<div class="row" style="border-top: 1px solid #f4f4f4; padding-top: 10px;">
										<div class="col-md-12">
											<div class="form-group">
												<label for="subject" th:text="#{module.email.subject}"></label>
												<input class="form-control" name="subject" th:value="*{subject}"></input>
												<span class="help-block"></span>
											</div>
										</div>
										<div class="col-md-12">
											<div class="form-group">
												<label for="text" th:text="#{module.email.text}"></label>
												<textarea class="form-control" name="text" th:text="*{text}"></textarea>
												<span class="help-block"></span>
											</div>
										</div>
										<div class="col-md-12">
											<div class="form-group">
												<label for="html" th:text="#{module.email.html}"></label>
												<textarea id="editorUpdateEmailHtml" name="html" rows="10" cols="80" th:text="*{html}"></textarea>
												<span class="help-block"></span>
											</div>
										</div>
										<div class="col-md-12" th:if="*{uuid != null}">
											<label th:text="#{module.email.attachment}"></label>
											<table id="attachmentTable" class="table table-bordered table-hover">
												<thead>
													<tr>
														<th th:text="#{module.email.attachment.name}"></th>
														<th style="width: 70px" class="action" sec:authorize="hasAuthority('email_update')" th:text="#{module.backoffice.action}"></th>
													</tr>
												</thead>
												<tbody>
													<tr th:each="row : *{attachments}">
														<td th:text="${row.getName()}"></td>
														<td sec:authorize="hasAuthority('email_update')">
															<button type="button" class="btn btn-block btn-danger btn-sm" data-toggle="modal" data-target="#modal-deleteattachment" th:data-emailuuid="*{uuid}" th:data-filename="${row.getName()}"
																th:text="#{module.backoffice.delete}"></button>
														</td>
													</tr>
												</tbody>
												<tfoot sec:authorize="hasAuthority('email_update')">
													<tr>
														<td colspan="1"></td>
														<td>
															<!-- Button trigger modal -->
															<a class="btn btn-block btn-default" data-toggle="modal" data-target="#modal-createattachment">
																<span class="fa fa-plus color"></span>
																<span th:text="#{module.backoffice.add}"></span>
															</a>
														</td>
													</tr>
												</tfoot>
											</table>
										</div>
									</div>
								</div>
								<!-- /.box-body -->
							</div>
							<!-- /.tab-pane -->
							<div class="tab-pane" id="tab_status">
								<div class="box-body">
									<div class="row">
										<div class="col-md-6" th:if="*{uuid != null}">
											<div class="form-group">
												<label for="status" th:text="#{module.email.status}+': '"></label>
												<span class="text-block" th:text="*{status}"></span>
											</div>
										</div>
										<div class="col-md-6" th:if="*{uuid != null}">
											<div class="form-group">
												<label for="exception" th:text="#{module.email.exception}+': '"></label>
												<span class="text-block" th:text="*{message}"></span>
											</div>
										</div>
									</div>
								</div>
							</div>
							<!-- /.tab-pane -->
							<div class="tab-pane" id="tab_history">
								<div class="box-body">
									<th:block layout:insert="~{/backoffice/adminlte/common/component/history :: history (historyListUrl=@{${@environment.getProperty('path.api.email.history')}(uuid=*{uuid})} )}"></th:block>
								</div>
							</div>
							<!-- /.tab-pane -->
							<div class="tab-pane" id="tab_administration">
								<div class="box-body">
									<th:block layout:insert="~{/backoffice/adminlte/common/component/administration :: administration}"></th:block>
								</div>
							</div>
							<!-- /.tab-pane -->
						</div>
						<!-- /.tab-content -->
					</div>
					<!-- nav-tabs-custom -->
				</div>
				<!-- /.col -->
			</div>
		</form>
		<div class="modal fade" id="modal-createattachment">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" th:text="#{module.email.attachment}"></h4>
					</div>
					<form id="email-createattachment-form" role="form" th:action="@{${@environment.getProperty('path.email')}}" method="post" th:object="${emailUpdate}" enctype="multipart/form-data">
						<input type="hidden" name="createattachment">
						<input type="hidden" name="uuid" th:value="${emailUpdate.uuid}">
						<div class="modal-body">
							<div class="modal-body">
								<div class="container-fluid">
									<div class="row">
										<div class="col-md-12">
											<div class="form-group">
												<label for="uploadAttachments" th:text="#{module.email.attachment}"></label>
												<input type="file" class="form-control" name="uploadAttachments" multiple>
												<span class="help-block"></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default pull-left" data-dismiss="modal" th:text="'  '+#{module.backoffice.cancel}+'  '"></button>
							<button type="submit" class="btn btn-success" th:text="#{module.backoffice.save}"></button>
						</div>
					</form>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<div class="modal fade" id="modal-deleteattachment">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" th:text="#{module.email.attachment}+' '+#{module.backoffice.delete.confirm}"></h4>
					</div>
					<div class="modal-body" th:utext="#{module.backoffice.delete.confirm.info}"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default pull-left" data-dismiss="modal" th:text="'  '+#{module.backoffice.no}+'  '"></button>
						<form id="delete-email-form" th:action="@{${@environment.getProperty('path.email')}}" method="post" th:object="${emailSearch}">
							<input type="hidden" name="deleteattachment">
							<input type="hidden" name="uuid" th:value="${emailUpdate.uuid}">
							<input type="hidden" name="filename">
							<button type="submit" class="btn btn-danger" th:text="#{module.backoffice.delete}"></button>
						</form>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- CK Editor -->
		<script th:src="@{/static/adminlte/bower_components/ckeditor/ckeditor.js}"></script>
		<script th:inline="javascript">
		    /*<![CDATA[*/
		    	
		    CKEDITOR.replace('editorUpdateEmailHtml');
			
			$('#modal-deleteattachment').on('show.bs.modal', function(e) {

			    //get data-id attribute of the clicked element
			    var filename = $(e.relatedTarget).data('filename');
			
			    //populate the textbox
			    $(e.currentTarget).find('input[name="filename"]').val(filename);
			});
			
			function sendEmailByQueue(){
				$('#update-form input[name="status"]').val("PENDING");
				$('#update-form').submit();
			}
			
		    $(document).ready(function() {
		        $('#update-form').validate({
		        	onkeyup: function(element) {
		                this.element(element);
		            },
		        	onfocusout: false,
		        	ignore: [],
		            
		            invalidHandler: function(form, validator) {
		                var errors = validator.numberOfInvalids();
		                if (errors) {                    
		                    validator.errorList[0].element.focus();
		                }
		            },
		            rules: {
		            	name: {
		                    required: true
		                }
		            },
		            messages: {
		            	subject: {
		                    required: /*[[#{module.email.name.required}]]*/
		                }
		            },
		            highlight: function(element) {
		                $(element).closest('.form-group').addClass('has-error');
		                
		                var id = $(element).closest('.tab-pane').attr('id');
		                $('.tab-content.tab-validate .tab-pane:has(div.has-error)').each(function() {
		                    $('.nav.nav-tabs').find('a[href^="#' + id + '"]').css('color','#dd4b39');
		                });
		            },
		            unhighlight: function(element) {
		                $(element).closest('.form-group').removeClass('has-error');
		                $(element).closest('.form-group').find('.help-block').html('');
		                
		                var id = $(element).closest('.tab-pane').attr('id');
		                var noError = true;
		                $('.tab-content.tab-validate .tab-pane:has(div.has-error)').each(function() {
		                    noError = false;
		                });
		                if(noError){
			                $('.nav.nav-tabs').find('a[href^="#' + id + '"]').css('color','black');
		                }
		            },
		            errorPlacement: function(error, element) {
		                element.closest('.form-group').find('.help-block').html(error.text());
		            }
		        });
		
		    });
		    /*]]>*/
		</script>

		<th:block
			layout:insert="~{/backoffice/adminlte/common/component/delete :: delete (deleteAction=@{${@environment.getProperty('path.email')}}, objectSearch=${emailSearch}, deleteUuid=${emailUpdate.uuid})}"></th:block>
	</th:block>
</body>
</html>