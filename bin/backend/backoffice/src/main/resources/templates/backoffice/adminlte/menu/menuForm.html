<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	layout:decorate="~{${@environment.getProperty('layout.backoffice')}}">
<head>
<title th:utext="#{module.menu}"></title>
</head>
<body>
	<th:block layout:fragment="update">
		<form id="menu-update-form" role="form" th:action="${@environment.getProperty('path.menu')}" method="post" th:object="${menuDto}">
			<input type="hidden" name="create" th:if="*{uuid == null}" />
			<input type="hidden" name="update" th:if="*{uuid != null}" />
			<input type="hidden" name="uuid" th:value="${menuDto.uuid}" />
			<input type="hidden" class="form-control" name="parent.uuid" th:if="*{parent != null}" th:value="*{parent.uuid}">
			<th:block th:each="child,itrStat : *{childs}">
				<input type="hidden" th:name="'childs['+${itrStat.index}+'].uuid'" th:value="${child.uuid}">
			</th:block>
			<div class="row">
				<div class="col-md-12">
					<div class="box box-solid">
						<div class="box-body bg-gray">
							<div class="row">
								<div class="col-xs-4 col-sm-6 col-md-6 col-lg-6">
									<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal-delete" sec:authorize="hasAuthority('menu_delete')">
										<i class="fa fa-trash"></i>
									</button>
								</div>
								<div class="col-xs-8 col-sm-6 col-md-6 col-lg-6" style="text-align: right">
									<a class="btn btn-default" th:text="#{module.backoffice.refresh}" onclick="window.location.reload()"></a>
									<button type="submit" class="btn btn-success" th:text="#{module.backoffice.save}" sec:authorize="hasAuthority('menu_update')"></button>
								</div>
							</div>
						</div>
						<!-- /.box-header -->
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<!-- Custom Tabs -->
					<div class="nav-tabs-custom">
						<ul class="nav nav-tabs">
							<li class="active">
								<a href="#tab_general" data-toggle="tab" th:text="#{module.backoffice.general}" onclick="changeTab('general')"></a>
							</li>
							<li>
								<a href="#tab_attribute" data-toggle="tab" th:text="#{module.backoffice.attribute}" onclick="changeTab('attribute')"></a>
							</li>
							<li sec:authorize="hasAuthority('usergroup_read')">
								<a href="#tab_usergroup" data-toggle="tab" th:text="#{module.usergroup}" onclick="changeTab('usergroup')"></a>
							</li>
							<li th:if="*{uuid != null}">
								<a href="#tab_history" data-toggle="tab" th:text="#{module.history}" onclick="changeTab('history')"></a>
							</li>
							<li th:if="*{uuid != null}">
								<a href="#tab_administration" data-toggle="tab" th:text="#{module.backoffice.administration}" onclick="changeTab('administration')"></a>
							</li>
						</ul>
						<div class="tab-content">
							<div class="tab-pane active" id="tab_general">
								<div class="box-body">
									<div class="row">
										<th:block layout:insert="~{common/adminlte/common/component/general :: general}"></th:block>
									</div>
									<div class="row" style="border-top: 1px solid #f4f4f4; padding-top: 10px;">
										<div class="col-md-6">
											<div class="form-group">
												<label for="name" th:text="#{module.menu.name}"></label>
												<span>*</span>
												<input type="text" class="form-control" name="name" th:value="*{name}">
												<span class="help-block"></span>
											</div>
										</div>
										<div class="col-md-6">
											<div class="form-group">
												<label for="sort" th:text="#{module.menu.sort}"></label>
												<span>*</span>
												<input type="text" class="form-control" name="sort" th:value="*{sort}" min="0" step="1" onkeypress="return isNumberKey(event)">
												<span class="help-block"></span>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label for="path" th:text="#{module.menu.path}"></label>
												<small th:text="#{module.menu.path.indicate}"></small>
												<input type="text" class="form-control" name="path" th:value="*{path}">
												<span class="help-block"></span>
											</div>
										</div>
										<div class="col-md-6">
											<div class="form-group">
												<label for="target" th:text="#{module.menu.target}"></label>
												<small th:text="#{module.menu.target.indicate}"></small>
												<select class="form-control" name="target">
													<option th:text="'&nbsp'"></option>
													<option th:each="targetEnum : ${T(com.beanframework.menu.domain.MenuTargetTypeEnum).values()}" th:value="${target}" th:selected="*{target} == ${targetEnum} ? true : false"
														th:text="${targetEnum.toString()}"></option>
												</select>
												<span class="help-block"></span>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-md-6">
											<div class="form-group">
												<label for="icon" th:text="#{module.menu.icon}"></label>
												<input type="text" class="form-control" name="icon" th:value="*{icon}">
												<span class="help-block"></span>
											</div>
										</div>
										<div class="col-md-6">
											<div class="form-group">
												<label for="active" th:text="#{module.menu.enabled}"></label>
												<select class="form-control" name="enabled">
													<option th:text="'&nbsp'"></option>
													<option value="1" th:selected="*{enabled == true}" th:text="#{module.backoffice.yes}"></option>
													<option value="0" th:selected="*{enabled == false}" th:text="#{module.backoffice.no}"></option>
												</select>
												<span class="help-block"></span>
											</div>
										</div>
									</div>
									<div class="row" style="border-top: 1px solid #f4f4f4; padding-top: 10px;" th:if="*{uuid != null}">
										<div class="col-md-12">
											<div class="form-group">
												<label th:text="#{module.backoffice.selected}+#{module.usergroup}"></label>
												<span>:</span>
												<table class="table table-bordered" id="usergroups-table">
													<thead>
														<tr>
															<th class="text-center" th:text="#{module.backoffice.name}"></th>
														</tr>
													</thead>
													<tbody>
														<tr th:each="userGroup : *{userGroups}">
															<td>
																<span th:text="${userGroup.name}"></span>
															</td>
														</tr>
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
								<!-- /.box-body -->
							</div>
							<!-- /.tab-pane -->
							<div class="tab-pane" id="tab_attribute">
								<div class="box-body">
									<div class="row">
										<th:block layout:insert="~{common/adminlte/common/component/attribute :: attribute}"></th:block>
									</div>
								</div>
								<!-- /.box-body -->
							</div>
							<!-- /.tab-pane -->
							<div class="tab-pane" id="tab_usergroup" sec:authorize="hasAuthority('usergroup_read')">
								<div class="box-body">
									<th:block layout:insert="~{common/adminlte/common/component/usergroup :: usergroup (userGroups='userGroups')}"></th:block>
								</div>
								<!-- /.box-body -->
							</div>
							<!-- /.tab-pane -->
							<div class="tab-pane" id="tab_history" th:if="*{uuid != null}">
								<div class="box-body">
									<th:block layout:insert="~{common/adminlte/common/component/history :: history (historyListUrl=@{${@environment.getProperty('path.api.menu.history')}(uuid=*{uuid})} )}"></th:block>
								</div>
							</div>
							<!-- /.tab-pane -->
							<div class="tab-pane" id="tab_administration" th:if="*{uuid != null}">
								<div class="box-body">
									<th:block layout:insert="~{common/adminlte/common/component/administration :: administration}"></th:block>
								</div>
							</div>
							<!-- /.tab-pane -->
						</div>
						<!-- /.tab-content -->
					</div>
					<!-- nav-tabs-custom -->
				</div>
				<!-- /.col -->
			</div>
		</form>
		<div class="modal fade" id="modal-delete" th:if="${menuDto.uuid != null}">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" th:text="#{module.backoffice.delete.confirm}"></h4>
					</div>
					<div class="modal-body" th:utext="#{module.backoffice.delete.confirm.info}"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default pull-left" data-dismiss="modal" th:text="'  '+#{module.backoffice.no}+'  '"></button>
						<form id="delete-menu-form" th:action="@{${@environment.getProperty('path.menu')}}" method="post">
							<input type="hidden" name="delete">
							<input type="hidden" name="uuid" th:value="${menuDto.uuid}">
							<button type="submit" class="btn btn-danger" th:text="#{module.backoffice.delete}"></button>
						</form>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- /.modal -->
		<script th:inline="javascript">
		    /*<![CDATA[*/
		    		    	
		    $(document).ready(function() {
		    	
		    	$('#usergroups-table').DataTable({
				      'paging'      : true,
				      'lengthChange': false,
				      'searching'   : true,
				      'ordering'    : true,
				      'info'        : false,
				      'autoWidth'   : true,
				      'sDom': "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
		    	      "<'row'<'col-sm-12'tr>>" +
		    	      "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"
				});
		    			    	
		    	// Handle form submission event
			   $('#menu-update-form').on('submit', function(e){
			      var form = this;
			
			      // Encode a set of form elements from all pages as an array of names and values
			      var params = jQuery('#usergroupTable').dataTable().$('input,select,textarea').serializeArray();
			
			      // Iterate over all form elements
			      $.each(params, function(){
			         // If element doesn't exist in DOM
			         if(!$.contains(document, form[this.name])){
			            // Create a hidden element
			            $(form).append(
			               $('<input>')
			                  .attr('type', 'hidden')
			                  .attr('name', this.name)
			                  .val(this.value)
			            );
			         }
			      });
			   });
		        
		        $('#menu-update-form').validate({
		            rules: {
		            	id: {
		                    required: true,
		                    remote: {
		                        url: /*[[${@environment.getProperty('path.api.menu.checkid')}]]*/ ,
		                        type: "get",
		                        data: {
		                            uuid: /*[[${menuDto.uuid}]]*/ ,
		                            id: function() {
		                                return $("#menu-update-form input[name='id']").val();
		                            }
		                        }
		                    }
		                },
		                name: {
		                    required: true
		                },
		                sort: {
		                    required: true
		                }
		            },
		            messages: {
		            	id: {
		                    required: /*[[#{module.menu.id.required}]]*/ ,
		                    remote: /*[[#{module.menu.id.exists}]]*/
		                },
		                name: {
		                    required: /*[[#{module.menu.name.required}]]*/
		                }
		            },
		            highlight: function(element) {
		                $(element).closest('.form-group').addClass('has-error');
		                
		                var id = $(element).closest('.tab-pane').attr('id');
		                $('.tab-content.tab-validate .tab-pane:has(div.has-error)').each(function() {
		                    $('.nav.nav-tabs').find('a[href^="#' + id + '"]').css('color','#dd4b39');
		                });
		            },
		            unhighlight: function(element) {
		                $(element).closest('.form-group').removeClass('has-error');
		                $(element).closest('.form-group').find('.help-block').html('');
		                
		                var id = $(element).closest('.tab-pane').attr('id');
		                var noError = true;
		                $('.tab-content.tab-validate .tab-pane:has(div.has-error)').each(function() {
		                    noError = false;
		                });
		                if(noError){
			                $('.nav.nav-tabs').find('a[href^="#' + id + '"]').css('color','black');
		                }
		            },
		            errorPlacement: function(error, element) {
		                element.closest('.form-group').find('.help-block').html(error.text());
		            }
		        });
		
		    });
		    /*]]>*/
		</script>
	</th:block>
</body>
</html>